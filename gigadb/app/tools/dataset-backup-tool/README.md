# Tools for GigaDB: dataset-backup-tool

## Set up

To run the Tencent backup smoke tests, the tests need access to a Tencent Cloud
account which is provided by these variables: `TENCENTCLOUD_SECRET_ID`,
`TENCENTCLOUD_SECRET_KEY`, `TENCENTCLOUD_APP_ID`. These variables need to be 
added as new GitLab secrets. 

These new variables need to be pulled into the `.secrets` file and a 
configuration file, `.cos.conf` and shell scripts, `create_bucket.sh` and `
delete_bucket.sh` created in the `dataset-backup-tool/scripts` directory:
```
$ docker-compose run --rm config
```
The smoke tests uses these shell scripts for creating and deleting a Tencent 
bucket at the start and end of the tests. The `.cos.conf` file provides 
configuration for running `coscmd` commands in `BackupSmokeCest` functional test 
class.

## Run Tencent coscmd based backup smoke tests

Change directory to the `dataset-backup-tool`:
```
$ cd gigadb/app/tools/dataset-backup-tool
```

There are 3 smoke tests in `tests/functional/BackupSmokeCest` which backup data
files to a `dataset` directory in a Tencent bucket:
* `tryBackupDataset` will upload 3 files from the `tests/_data/dataset1` 
  directory into the `dataset` directory in a Tencent bucket.
* `tryUpdateBackupWithChangedFile` checks that the `coscmd` tool can detect 
  differences between files. This test should only upload `test.csv` from
  `tests/_data/dataset2` into the Tencent `dataset` backup directory since only 
  this csv file is different in the `dataset2` directory compared to the 
  `dataset1` directory.
* `tryUpdateBackupWithDeletedFile` checks that the `--delete` parameter is able
  to synchronise the contents of a source directory with its counterpart 
  directory in a Tencent bucket. The `tests/_data/dataset3` directory is missing
  `test.tsv` so this test checks that the `test.tsv` file in the Tencent bucket 
  `dataset` directory has been deleted.

To run these smoke tests:
```
$ docker-compose run --rm backup_tool ./vendor/bin/codecept run tests/functional/BackupSmokeCest.php
```

## RClone

### Setup

Rclone is the recommended approach for operating the backup workflows.
``gigadb/app/tools/dataset-backup-tool/config/rclone.conf`` is the configuration file to enable rclone to operate on Tencent Cloud.
That configuration is generated by the same ``generate_config.sh`` aforementioned
based on the template ``gigadb/app/tools/dataset-backup-tool/config/rclone.conf.dist``

The setup has its own smoke tests that can be run using this way:
```
$ cd gigadb/app/tools/dataset-backup-tool
$ docker-compose run --rm backup_tool ./vendor/bin/codecept run -g rclone-setup tests/functional
```

For the benefit of the tests, the configuration file is bind-mounted to the ``backup_tool`` 
container service in ``gigadb/app/tools/dataset-backup-tool/docker-compose.yml`` and rclone itself is deployed to the 
base image in ``gigadb/app/tools/dataset-backup-tool/Dockerfile``.





