t_gigadb:
  stage: test
  cache:
    paths:
      - vendor/
      - composer.lock
  artifacts:
    paths:
      - tmp/
      - protected/runtime/mail/
      - protected/runtime/coverage/
      - protected/runtime/application.log
      - protected/runtime/phpunit-coverage.txt
      - protected/runtime/clover.xml
      - protected/config/main.php
      - protected/config/test.php
      - fuw/app/backend/runtime/
      - fuw/app/frontend/runtime/
      - fuw/app/console/runtime/
      - fuw/app/common/tests/_output
      - fuw/app/common/config/params-local.php
      - gigadb/app/tools/files-url-updater/config/params.php
      - .env
      - .secrets
      - composer.lock
      - containers-data
      - tests
    when: always
    expire_in: 1 week
  script:
    # appending dev variables at the end of the .env and .secrets
    - env | grep "^HOME_URL" >> $APPLICATION/.env
    - env | grep "^GIGADB_" >> $APPLICATION/.secrets
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/application:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/test:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/console:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/web:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/tusd:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/ftpd:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/watcher:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/tusd:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/beanstalkd:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/web:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/js:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/fuw-admin:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/fuw-worker:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/gigadb-worker:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/fuw-public:latest || true
    - env
    - ./up.sh
    - cd $APPLICATION
    - ./tests/all_and_coverage
  environment:
    name: dev
