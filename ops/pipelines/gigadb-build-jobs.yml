base_images:
  stage: .pre
  script:
    # login and pull from docker hub the base image for php-fpm so it's done only once
    - docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD
    - docker pull php:7.1.33-fpm-buster
    - docker save -o php-7_1-fpm-buster.tar php:7.1.33-fpm-buster
    - docker pull php:7.2.34-fpm-buster
    - docker save -o php-7_2-fpm-buster.tar php:7.2.34-fpm-buster
    - docker pull php:7.2.34-cli-buster
    - docker save -o php-7_2-cli-buster.tar php:7.2.34-cli-buster
    - docker pull alpine:3.14.2
    - docker save -o alpine-3_14.tar alpine:3.14.2
    - docker pull nginx:1.21.3-alpine
    - docker save -o nginx-1_21-alpine.tar nginx:1.21.3-alpine
    - docker pull node:14.18.0-buster
    - docker save -o node-14-buster.tar node:14.18.0-buster
  artifacts:
    paths:
      - php-7_1-fpm-buster.tar
      - php-7_2-fpm-buster.tar
      - php-7_2-cli-buster.tar
      - alpine-3_14.tar
      - nginx-1_21-alpine.tar
      - node-14-buster.tar

b_gigadb:
  stage: build for test
  script:
    # Load Base image
    - docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD
    - docker load -i php-7_1-fpm-buster.tar
    - docker load -i php-7_2-fpm-buster.tar
    - docker load -i php-7_2-cli-buster.tar
    - docker load -i alpine-3_14.tar
    - docker load -i nginx-1_21-alpine.tar
    - docker load -i node-14-buster.tar
    # login to gitlab container registry
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
    # build for test
    - echo "Building app"
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/application:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/test:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/fuw-admin:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/fuw-worker:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/gigadb-worker:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/fuw-public:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/console:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/ftpd:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/watcher:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/tusd:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/beanstalkd:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/web:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/js:latest || true
    - docker-compose build application
    - docker-compose build test
    - docker-compose build fuw-admin
    - docker-compose build fuw-worker
    - docker-compose build gigadb-worker
    - docker-compose build fuw-public
    - docker-compose build console
    - docker-compose build ftpd
    - docker-compose build watcher
    - docker-compose build tusd
    - docker-compose build beanstalkd
    - docker-compose build web
    - docker-compose build js
    - docker tag ${CI_PROJECT_NAME}_application:latest registry.gitlab.com/$CI_PROJECT_PATH/application:latest
    - docker tag ${CI_PROJECT_NAME}_test:latest registry.gitlab.com/$CI_PROJECT_PATH/test:latest
    - docker tag ${CI_PROJECT_NAME}_fuw-admin:latest registry.gitlab.com/$CI_PROJECT_PATH/fuw-admin:latest
    - docker tag ${CI_PROJECT_NAME}_fuw-worker:latest registry.gitlab.com/$CI_PROJECT_PATH/fuw-worker:latest
    - docker tag ${CI_PROJECT_NAME}_gigadb-worker:latest registry.gitlab.com/$CI_PROJECT_PATH/gigadb-worker:latest
    - docker tag ${CI_PROJECT_NAME}_fuw-public:latest registry.gitlab.com/$CI_PROJECT_PATH/fuw-public:latest
    - docker tag ${CI_PROJECT_NAME}_console:latest registry.gitlab.com/$CI_PROJECT_PATH/console:latest
    - docker tag ${CI_PROJECT_NAME}_ftpd:latest registry.gitlab.com/$CI_PROJECT_PATH/ftpd:latest
    - docker tag ${CI_PROJECT_NAME}_watcher:latest registry.gitlab.com/$CI_PROJECT_PATH/watcher:latest
    - docker tag ${CI_PROJECT_NAME}_tusd:latest registry.gitlab.com/$CI_PROJECT_PATH/tusd:latest
    - docker tag ${CI_PROJECT_NAME}_beanstalkd:latest registry.gitlab.com/$CI_PROJECT_PATH/beanstalkd:latest
    - docker tag ${CI_PROJECT_NAME}_web:latest registry.gitlab.com/$CI_PROJECT_PATH/web:latest
    - docker tag ${CI_PROJECT_NAME}_js:latest registry.gitlab.com/$CI_PROJECT_PATH/js:latest
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/application:latest
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/test:latest
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/fuw-admin:latest
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/fuw-worker:latest
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/gigadb-worker:latest
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/fuw-public:latest
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/console:latest
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/ftpd:latest
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/watcher:latest
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/tusd:latest
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/beanstalkd:latest
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/web:latest
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/js:latest
    - docker-compose run --rm config
    - docker-compose run --rm fuw-config
    - docker-compose run --rm test composer install
    - docker-compose run --rm console bash -c "cd /app && composer update"
    - docker-compose run --rm console bash -c 'cd /gigadb-apps/worker/file-worker/ && composer update'
    - docker-compose run --rm js npm install
  artifacts:
    untracked: true
    when: always
    expire_in: 1 week


.pb_gigadb:
  variables:
    GIGADB_ENV: $DEPLOYMENT_ENV
    COMPOSE_FILE: "ops/deployment/docker-compose.yml:ops/deployment/docker-compose.ci.yml:ops/deployment/docker-compose.build.yml"
    REMOTE_DOCKER_HOST: "$remote_public_ip:2376"
    DATA_SAVE_PATH: "/home/centos/app_data"
    CSV_DIR: "prod_like"
  stage: production build
  allow_failure: false
  script:
    # Load Base image
    - docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD
    - docker load -i php-7_1-fpm-buster.tar
    - docker load -i php-7_2-fpm-buster.tar
    - docker load -i php-7_2-cli-buster.tar
    - docker load -i alpine-3_14.tar
    - docker load -i nginx-1_21-alpine.tar
    - docker load -i node-14-buster.tar
    # login to gitlab container registry
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
    # appending remote variables at the end of the .env and .secrets
    - env > full_env.txt
    - env | grep -v "SAST" | grep -iE "^(staging_|remote_)" | grep -viE "(password|email|tester|secret|key|user|app_id|client_id|token|tlsauth)" >> $APPLICATION/.env
    - env | grep -v "SAST" | grep -iE "^(staging_|remote_)" | grep -iE "(password|email|tester|secret|key|user|app_id|client_id|token)" | grep -viE "tlsauth">> $APPLICATION/.secrets
    - env | grep -v "SAST" | grep -iE "gitlab_private_token">> $APPLICATION/.secrets
    - env | grep -v "SAST" | grep -iE "CI_PROJECT_URL">> $APPLICATION/.secrets
    - env | grep -v "SAST" | grep -iE "^(gigadb_|fuw_).+=.+$" | tee -a $APPLICATION/.secrets
    # pulling the CI build of the application from registry and configure it for staging for the purpose of building production containers
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/application:latest || true
#    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/fuw-admin:latest || true
#    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/fuw-public:latest || true
#    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/fuw-worker:latest || true
#    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/gigadb-worker:latest || true
    # Generate configuration files and vendors libraries before baking an immutable image
    - docker-compose run --rm config
    - docker-compose run --rm application composer install -a --no-dev
    - docker-compose run --rm less
#    - docker-compose run --rm fuw-config
#    - docker-compose run --rm console bash -c "cd /app && composer install -a --no-dev"
#    - docker-compose run --rm console bash -c 'cd /gigadb-apps/worker/file-worker/ && composer install -a --no-dev'
    # Share the model layer across apps
#    - cp gigadb/app/worker/file-worker/models/UpdateGigaDBJob.php fuw/app/
    # Generate Yii migration scripts
    - docker-compose up csv-to-migrations
    # pulling production build of images from registry to use as cache
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/production_app:$GIGADB_ENV || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/production_config:$GIGADB_ENV || true
#    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/production_fuw-console:latest || true
#    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/production_fuw-admin:latest || true
#    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/production_fuw-public:latest || true
#    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/production_fuw-worker:latest || true
#    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/production_gigadb-worker:latest || true
#    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/production_ftpd:latest || true
#    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/production_watcher:latest || true
#    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/production_tusd:latest || true
#    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/production_beanstalkd:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/production_web:$GIGADB_ENV || true
    # build the javascript app, so that the Vue.js app can be baked in production_app
#    - docker-compose run --rm js
    # build Nginx web container, making sure static assets are baked in
#    - cp -R fuw/app/backend ops/configuration/fuw-conf/
    - docker-compose build production_web
    # build and push production containers for PHP-FPM with application code and vendor code baked in and publish to registry
    - docker-compose build production_app
    - docker-compose build production_config
    - docker tag ${CI_PROJECT_NAME}_production_web:latest registry.gitlab.com/$CI_PROJECT_PATH/production_web:$GIGADB_ENV
    - docker tag ${CI_PROJECT_NAME}_production_app:latest registry.gitlab.com/$CI_PROJECT_PATH/production_app:$GIGADB_ENV
    - docker tag ${CI_PROJECT_NAME}_production_config:latest registry.gitlab.com/$CI_PROJECT_PATH/production_config:$GIGADB_ENV
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/production_web:$GIGADB_ENV
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/production_app:$GIGADB_ENV
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/production_config:$GIGADB_ENV
    # build and push sidecar apps (ftpd, watcher, tusd, beanstalkd) for FUW
#    - docker-compose build production_ftpd
#    - docker-compose build production_watcher
#    - docker-compose build production_tusd
#    - docker-compose build production_beanstalkd
#    - docker tag ${CI_PROJECT_NAME}_production_ftpd:latest registry.gitlab.com/$CI_PROJECT_PATH/production_ftpd:$GIGADB_ENV
#    - docker tag ${CI_PROJECT_NAME}_production_watcher:latest registry.gitlab.com/$CI_PROJECT_PATH/production_watcher:$GIGADB_ENV
#    - docker tag ${CI_PROJECT_NAME}_production_tusd:latest registry.gitlab.com/$CI_PROJECT_PATH/production_tusd:$GIGADB_ENV
#    - docker tag ${CI_PROJECT_NAME}_production_beanstalkd:latest registry.gitlab.com/$CI_PROJECT_PATH/production_beanstalkd:$GIGADB_ENV
#    - docker push registry.gitlab.com/$CI_PROJECT_PATH/production_ftpd:$GIGADB_ENV
#    - docker push registry.gitlab.com/$CI_PROJECT_PATH/production_watcher:$GIGADB_ENV
#    - docker push registry.gitlab.com/$CI_PROJECT_PATH/production_tusd:$GIGADB_ENV
#    - docker push registry.gitlab.com/$CI_PROJECT_PATH/production_beanstalkd:$GIGADB_ENV
    # build and push production container images for File Upload Wizard apps
#    - docker-compose build production_fuw-console
#    - docker-compose build production_fuw-admin
#    - docker-compose build production_fuw-public
#    - docker-compose build production_fuw-worker
#    - docker-compose build production_gigadb-worker
#    - docker tag ${CI_PROJECT_NAME}_production_fuw-console:latest registry.gitlab.com/$CI_PROJECT_PATH/production_fuw-console:$GIGADB_ENV
#    - docker tag ${CI_PROJECT_NAME}_production_fuw-admin:latest registry.gitlab.com/$CI_PROJECT_PATH/production_fuw-admin:$GIGADB_ENV
#    - docker tag ${CI_PROJECT_NAME}_production_fuw-public:latest registry.gitlab.com/$CI_PROJECT_PATH/production_fuw-public:$GIGADB_ENV
#    - docker tag ${CI_PROJECT_NAME}_production_fuw-worker:latest registry.gitlab.com/$CI_PROJECT_PATH/production_fuw-worker:$GIGADB_ENV
#    - docker tag ${CI_PROJECT_NAME}_production_gigadb-worker:latest registry.gitlab.com/$CI_PROJECT_PATH/production_gigadb-worker:$GIGADB_ENV
#    - docker push registry.gitlab.com/$CI_PROJECT_PATH/production_fuw-console:$GIGADB_ENV
#    - docker push registry.gitlab.com/$CI_PROJECT_PATH/production_fuw-admin:$GIGADB_ENV
#    - docker push registry.gitlab.com/$CI_PROJECT_PATH/production_fuw-public:$GIGADB_ENV
#    - docker push registry.gitlab.com/$CI_PROJECT_PATH/production_fuw-worker:$GIGADB_ENV
#    - docker push registry.gitlab.com/$CI_PROJECT_PATH/production_gigadb-worker:$GIGADB_ENV
  environment:
    name: $DEPLOYMENT_ENV
    url: $REMOTE_HOME_URL
  when: manual
  artifacts:
    untracked: true
    when: on_failure
    expire_in: 1 week

build_staging:
  variables:
    GIGADB_ENV: "staging"
  extends: .pb_gigadb
  stage: staging build
  environment:
    name: "staging"
    url: $REMOTE_HOME_URL

build_live:
  variables:
    GIGADB_ENV: "live"
  extends: .pb_gigadb
  stage: live build
  environment:
    name: "live"
    deployment_tier: production
    url: $REMOTE_HOME_URL