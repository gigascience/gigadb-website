version: '3.7'

services:

  web:
    image: registry.gitlab.com/$CI_PROJECT_PATH/production_web:latest
    environment:
      YII_PATH: ${YII_PATH}
      YII2_PATH: ${YII2_PATH}
    volumes:
      - assets:/var/www/assets
      - le_config:/etc/letsencrypt
      - le_webrootpath:/var/www/.le
      - tempcaptcha:/var/www/images/tempcaptcha
    ports:
      - "${STAGING_PUBLIC_HTTP_PORT}:80"
      - "${STAGING_PUBLIC_HTTPS_PORT}:443"
    networks:
      web-tier:
        ipv4_address: 172.16.238.10
    cap_drop:
      - NET_ADMIN
      - SYS_ADMIN
    restart: unless-stopped

  config:
    image: registry.gitlab.com/$CI_PROJECT_PATH/production_config:latest
    volumes:
      - le_config:/etc/letsencrypt
    command: cp /le.staging.ini /etc/letsencrypt/cli.ini

  certbot:
    image: certbot/certbot
    volumes:
      - le_config:/etc/letsencrypt
      - le_webrootpath:/var/www/.le

  application:
    image: registry.gitlab.com/$CI_PROJECT_PATH/production_app:latest
    environment:
      YII_PATH: ${YII_PATH}
      YII2_PATH: ${YII2_PATH}
    volumes:
      - assets:/var/www/assets
      - tempcaptcha:/var/www/images/tempcaptcha
    expose:
      - "9000"
    networks:
      - web-tier
    extra_hosts:
      - "dockerhost:${staging_private_ip}"
    cap_drop:
      - NET_ADMIN
      - SYS_ADMIN
    restart: unless-stopped

  webapp:
    image: registry.gitlab.com/$CI_PROJECT_PATH/production_app:latest
    environment:
      YII_PATH: ${YII_PATH}
      YII2_PATH: ${YII2_PATH}
    cap_drop:
      - NET_ADMIN
      - SYS_ADMIN
    depends_on:
      - application
      - web
    command: ./ops/scripts/webapp_setup.sh
    networks:
      - web-tier
    volumes:
      - le_config:/etc/letsencrypt

  csv-to-migrations:
    image: node:14.9.0-buster
    working_dir: /var/www/ops/scripts
    shm_size: '1gb' # to avoid a known issue
    command: bash -c "npm install /var/www/ops/scripts && node /var/www/ops/scripts/csv_yii_migration.js $CSV_DIR"

networks:
  web-tier:
    driver: bridge
    ipam:
      driver: default
      config:
      - subnet: 172.16.238.0/24

volumes:
  assets:
  le_config:
  le_webrootpath:
  tempcaptcha:

