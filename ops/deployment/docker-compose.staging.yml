version: '3.7'

services:

  web:
    image: registry.gitlab.com/$CI_PROJECT_PATH/production_web:latest
    environment:
      YII_PATH: ${YII_PATH}
      YII2_PATH: ${YII2_PATH}
    volumes:
      - assets:/var/www/assets
    ports:
      - "${STAGING_PUBLIC_HTTP_PORT}:80"
      - "${STAGING_PUBLIC_HTTPS_PORT}:443"
    networks:
      web-tier:
        ipv4_address: 172.16.238.10

  application:
    image: registry.gitlab.com/$CI_PROJECT_PATH/production_app:latest
    environment:
      YII_PATH: ${YII_PATH}
      YII2_PATH: ${YII2_PATH}
    volumes:
      - assets:/var/www/assets
    expose:
      - "9000"
    networks:
      - web-tier
    extra_hosts:
      - "dockerhost:${STAGING_IP_ADDRESS}"

  webapp:
    image: registry.gitlab.com/$CI_PROJECT_PATH/production_app:latest
    environment:
      YII_PATH: ${YII_PATH}
      YII2_PATH: ${YII2_PATH}
    cap_drop:
      - NET_ADMIN
      - SYS_ADMIN
    depends_on:
      - application
      - web
    command: ./protected/yiic lesscompiler
    networks:
      - web-tier


networks:
  web-tier:
    driver: bridge
    ipam:
      driver: default
      config:
      - subnet: 172.16.238.0/24

volumes:
  assets:

