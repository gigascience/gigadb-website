#!/bin/bash

# Generated by chef. Don't ****ing touch!
# - unless you're editing the template (db_backup.erb) -

directory_name="<%= node[:gigadb][:db][:backup_folder] %>"

if [ -d $directory_name ]
then
    echo "Directory already exists"
else
   sudo mkdir -p $directory_name
   chown -R centos:gigadb-admin $directory_name
fi

filename=$directory_name$(date +%Y%m%d)".backup"
s3_prefix="s3://gigadb-backups/"
s3filename=$s3_prefix$(date +%Y%m%d)".backup"

PGPASSWORD="<%= node[:gigadb][:db][:password] %>" pg_dump -h localhost -p 5432 -U <%= node[:gigadb][:db][:user] %> -Fc <%= node[:gigadb][:db][:database] %> -f $filename

# Copy backup file to S3 and log output and errors
aws s3 cp $filename $s3filename >> /vagrant/logs/aws.log 2>&1
