#!/usr/bin/env bash

set -e

set -a
echo "Loading environment..."
source "./.env"
source "./.secrets"
set +a

echo "Checking coverage..."
# as generated by  <log type="coverage-text" target="/var/www/protected/runtime/phpunit-coverage.txt" showOnlySummary="true">
text_cov="/var/www/protected/runtime/phpunit-coverage.txt"

if [[ -n $GITLAB_PRIVATE_TOKEN && -n $GITLAB_UPSTREAM_PROJECT_ID && -n $MAIN_BRANCH ]];then
	echo "Retrieving last coverage value from main branch using GitLab"
	last_success_pipeline_from_main=$(curl -s --header "PRIVATE-TOKEN: $GITLAB_PRIVATE_TOKEN"  "https://gitlab.com/api/v4/projects/$GITLAB_UPSTREAM_PROJECT_ID/pipelines?status=success&ref=${MAIN_BRANCH}&per_page=1" | jq -r '.[0] | .id')
	previous_coverage_value=$(curl -s --header "PRIVATE-TOKEN: $GITLAB_PRIVATE_TOKEN"  "https://gitlab.com/api/v4/projects/$GITLAB_UPSTREAM_PROJECT_ID/pipelines/$last_success_pipeline_from_main" | jq -r '.coverage')
elif [[ -n $GITLAB_UPSTREAM_PROJECT_ID && -n $MAIN_BRANCH ]];then
	echo "Retrieving last coverage value from main branch using Coveralls"
	last_commit_from_main=$(curl -s "https://gitlab.com/api/v4/projects/$GITLAB_UPSTREAM_PROJECT_ID/repository/branches/$MAIN_BRANCH" | jq -r '.commit | .id')
	last_commit_from_main_coverage=$(curl -s https://coveralls.io/builds/${last_commit_from_main}.json | jq -r '.covered_percent')
	previous_coverage_value=$(printf "%.2f\n" $last_commit_from_main_coverage)
else
	echo "Using default reference value"
	previous_coverage_value=9.0
fi

if [[ -s $text_cov ]];then
	current_coverage_value=`head -6 $text_cov | tail -1 | cut -d':' -f 2 | cut -d'%' -f 1 | sed 's/ *//'`
else
	echo "Test Coverage report not fount at: $text_cov"
	echo "Ensure the PHPUnit tests have run and have generated a coverage report."
	echo "Otherwise check that phpunit.xml configuration file is correct."
	exit 1
fi

compare=`echo $current_coverage_value'<'$previous_coverage_value | bc -l`

if [[ $compare -eq 1 ]];then
	echo "Coverage has decreased! ($current_coverage_value < $previous_coverage_value)"
	exit 1
else
	echo "Coverage OK!"
	exit 0
fi
