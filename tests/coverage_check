#!/usr/bin/env bash

set -e -u

echo "Checking coverage..."
# as generated by  <log type="coverage-text" target="/var/www/protected/runtime/phpunit-coverage.txt" showOnlySummary="true">
text_cov="/var/www/protected/runtime/phpunit-coverage.txt"

LAST_COMMIT_FROM_MAIN=$(curl -s "https://gitlab.com/api/v4/projects/7041674/repository/branches/nolegacy-dep-ux-php7" | jq -r '.commit | .id')
last_commit_from_main_coverage=$(curl -s https://coveralls.io/builds/${LAST_COMMIT_FROM_MAIN}.json | jq -r '.covered_percent')

previous_coverage_value=$(printf "%.2f\n" $last_commit_from_main_coverage)

if [[ -s $text_cov ]];then
	current_coverage_value=`head -6 $text_cov | tail -1 | cut -d':' -f 2 | cut -d'%' -f 1 | sed 's/ *//'`
else
	echo "Test Coverage report not fount at: $text_cov"
	echo "Ensure the PHPUnit tests have run and have generated a coverage report."
	echo "Otherwise check that phpunit.xml configuration file is correct."
	exit 1
fi

compare=`echo $current_coverage_value'<'$previous_coverage_value | bc -l`

if [[ $compare -eq 1 ]];then
	echo "Coverage has decreased! ($current_coverage_value < $previous_coverage_value)"
	exit 1
else
	echo "Coverage OK!"
	exit 0
fi

#TODO: use gitlab and coverall to retrieve previous coverage:
#curl -s "https://gitlab.com/api/v4/projects/7041674/repository/branches/nolegacy-dep-ux-php7" | jq -r '.commit | .id'
#curl -s https://coveralls.io/builds/3ce191aab81330478686e39b9dbe05876cf056b6.json | jq -r '.covered_percent'