#!/usr/bin/env bash

set -e
set -u

echo "About to run  automated tests..."

echo "Loading environment..."
set -a
source "./.env"
set +a

echo "Loading test users"
set -a
source /var/www/.secrets
set +a

echo "First, backup the main database..."
exec 3>&1
exec 1> /dev/null
pg_dump $GIGADB_DB -U $GIGADB_USER -h $GIGADB_HOST -F custom  -f /var/www/sql/before-run.pgdmp
exec 1>&3

# echo "Running acceptance tests"
# if [[ "$GIGADB_ENV" == "dev" ]];then
# 	bin/behat --tags "@ok&&~@facebook" -v --stop-on-failure
# else
# 	# we are on CI with remote runner, affilate login tests don't work becasause Google and Twitter block it
# 	bin/behat --tags "@ok&&~@affiliate-login" -v --stop-on-failure --format progress -o std --format pretty --out=/var/www/protected/runtime/features.txt --format junit -o /var/www/protected/runtime/xml
# fi

./tests/run_phpunit_tests

echo "...all automated tests have run"

echo "Lastly, restoring the main database..."
exec 3>&1
exec 1> /dev/null
pg_restore -i -h $GIGADB_HOST  -U $GIGADB_USER -d $GIGADB_DB -c -v /var/www/sql/before-run.pgdmp
exec 1>&3